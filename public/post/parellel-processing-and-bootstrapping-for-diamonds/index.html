<!DOCTYPE html>
<html lang="en">
<head>

  <meta charset="utf-8" />

  
  <title>Parellel Processing and Bootstrapping for Diamonds</title>

  
  




  
  <meta name="author" content="Dusty Turner" />
  <meta name="description" content="IntroductionOften times, I run simulations on my computer to help educate my students about different statistical topics. In doing this, I often end up running fairly “long” simulations that take up more time than what I’d like to use in the classrooms.
Complaining about this let me to Googling, which, as usual, let me to a solution. Posted below is an example of what I learned with an accompanying ShinyApp which helps me explain bootstrapping to my students." />

  
  
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:site" content="@dtdusty" />
    <meta name="twitter:title" content="Parellel Processing and Bootstrapping for Diamonds" />
    <meta name="twitter:description" content="IntroductionOften times, I run simulations on my computer to help educate my students about different statistical topics. In doing this, I often end up running fairly “long” simulations that take up more time than what I’d like to use in the classrooms.
Complaining about this let me to Googling, which, as usual, let me to a solution. Posted below is an example of what I learned with an accompanying ShinyApp which helps me explain bootstrapping to my students." />
    <meta name="twitter:image" content="/img/boot.jpg" />
  




<meta name="generator" content="Hugo 0.72.0" />


<link rel="canonical" href="/post/parellel-processing-and-bootstrapping-for-diamonds/" />
<link rel="alternative" href="/index.xml" title="Dusty Turner" type="application/atom+xml" />


<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<meta name="format-detection" content="telephone=no,email=no,adress=no" />
<meta http-equiv="Cache-Control" content="no-transform" />


<meta name="robots" content="index,follow" />
<meta name="referrer" content="origin-when-cross-origin" />
<meta name="google-site-verification" content="-jH0wqxQCDh6JrcCbL9tuGso_EV4u1BRT93XjGqNsfo" />
<meta name="msvalidate.01" content="84DDAAE7986A2E9D73062694A69D33A9" />





<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="apple-mobile-web-app-title" content="Dusty Turner" />
<meta name="msapplication-tooltip" content="Dusty Turner" />
<meta name='msapplication-navbutton-color' content="#5fbf5e" />
<meta name="msapplication-TileColor" content="#5fbf5e" />
<meta name="msapplication-TileImage" content="/img/tile-image-windows.png" />
<link rel="icon" href="/img/favicon.ico" />
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png" />
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png" />
<link rel="icon" sizes="192x192" href="/img/touch-icon-android.png" />
<link rel="apple-touch-icon" href="/img/touch-icon-apple.png" />
<link rel="mask-icon" href="/img/safari-pinned-tab.svg" color="#5fbf5e" />



<link rel="stylesheet" href="//cdn.bootcss.com/video.js/6.2.8/alt/video-js-cdn.min.css" />

<link rel="stylesheet" href="/css/bundle.css" />
<link rel="stylesheet" href="/css/lightfair.css" rel="stylesheet" id="theme-stylesheet">
<script src="/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

  
  <!--[if lt IE 9]>
    <script src="//cdn.bootcss.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="//cdn.bootcss.com/respond.js/1.4.2/respond.min.js"></script>
    <script src="//cdn.bootcss.com/video.js/6.2.8/ie8/videojs-ie8.min.js"></script>
  <![endif]-->

<!--[if lte IE 11]>
    <script src="//cdn.bootcss.com/classlist/1.1.20170427/classList.min.js"></script>
  <![endif]-->


<script src="//cdn.bootcss.com/object-fit-images/3.2.3/ofi.min.js"></script>


<script src="//cdn.bootcss.com/smooth-scroll/12.1.4/js/smooth-scroll.polyfills.min.js"></script>


</head>
  <body>
    
    <div class="suspension">
      <a title="Go to top" class="to-top is-hide"><span class="icon icon-up"></span></a>
      
        
        <a title="Go to comments" class="to-comment" href="#disqus_thread"><span class="icon icon-comment"></span></a>
        
      
    </div>
    
    
  <header class="site-header">
  <img class="avatar" src="/img/dusty.png" alt="Avatar">
  
  <h2 class="title">Dusty Turner</h2>
  
  <p class="subtitle">~Data Science: Lightly Edited~</p>
  <button class="menu-toggle" type="button">
    <span class="icon icon-menu"></span>
  </button>
  <nav class="site-menu collapsed">
    <h2 class="offscreen">Main Menu</h2>
    <ul class="menu-list">
      
      
      
      
        <li class="menu-item  is-active"><a href="/">Home</a></li>
      
        <li class="menu-item "><a href="https://github.com/dusty-turner">Github</a></li>
      
        <li class="menu-item "><a href="/links/">Links</a></li>
      
        <li class="menu-item "><a href="/about/">About</a></li>
      
        <li class="menu-item "><a href="/community/">Community</a></li>
      
        <li class="menu-item "><a href="/cv.pdf">CV</a></li>
      
    </ul>
  </nav>
  <nav class="social-menu collapsed">
    <h2 class="offscreen">Social Networks</h2>
    <ul class="social-list">

      
      <li class="social-item">
        <a href="mailto:dusty.s.turner@gmail.com" title="Email"><span class="icon icon-email"></span></a>
      </li>

      
      <li class="social-item">
        <a href="//github.com/dusty-turner" title="GitHub"><span class="icon icon-github"></span></a>
      </li>

      <li class="social-item">
        <a href="//twitter.com/dtdusty" title="Twitter"><span class="icon icon-twitter"></span></a>
      </li>

      <li class="social-item">
        <a href="//www.facebook.com/dusty.turner" title="Facebook"><span class="icon icon-facebook"></span></a>
      </li>

      

      

      

      

      

      

      

      

      

      

      

      

      

      <li class="social-item">
        <a href="//www.linkedin.com/in/dusty-turner-34a148112" title="Linkedin"><span class="icon icon-linkedin"></span></a>
      </li>

      

      

      

      <li class="social-item">
        <a href="/index.xml"><span class="icon icon-rss" title="RSS"></span></a>
      </li>

    </ul>
  </nav>
</header>

  <section class="main post-detail">
    <header class="post-header">
      <h1 class="post-title">Parellel Processing and Bootstrapping for Diamonds</h1>
      <p class="post-meta">@Dusty Turner · Jun 5, 2019 · 6 min read</p>
    </header>
    <article class="post-content">


<div id="introduction" class="section level2">
<h2>Introduction</h2>
<p>Often times, I run simulations on my computer to help educate my students about different statistical topics. In doing this, I often end up running fairly “long” simulations that take up more time than what I’d like to use in the classrooms.</p>
<p>Complaining about this let me to Googling, which, as usual, let me to a solution. Posted below is an example of what I learned with an accompanying ShinyApp which helps me explain bootstrapping to my students.</p>
</div>
<div id="gratitude" class="section level2">
<h2>Gratitude</h2>
<p>Much of what I learned I figured out from this nice <a href="https://nceas.github.io/oss-lessons/parallel-computing-in-r/parallel-computing-in-r.html">blog post</a> by Matt Jones.</p>
</div>
<div id="problem-to-solve" class="section level2">
<h2>Problem to Solve</h2>
<p>To motivate this problem, I decided I wanted to bootstrap from the <strong>diamonds</strong> data-set to create a range of coefficients which could be the slope and intercept for the linear relationship between the price and cut/carat. Because this could feasibly take a while, I wanted to use parallel processing to split up the bootstrapping portion on several cores.</p>
</div>
<div id="my-old-way" class="section level2">
<h2>My Old Way</h2>
<p>This is how the old me would have done it. I ran a ‘for’ loop to create 100 bootstraped linear regression of a sample from the data.</p>
<pre class="r"><code>data(&quot;diamonds&quot;)

diamonds = diamonds %&gt;%
  select(price,carat,cut)

coefdf = NULL
allsamples = NULL
system.time({
  for (i in 1:100) {
    subsample = diamonds %&gt;%
      sample_frac(.001) %&gt;%
      mutate(iteration = i)
    result = lm(price~cut+carat,data = subsample)
    coef = coefficients(result)
    coefdf = coefdf %&gt;%
      bind_rows(coef)
    allsamples = allsamples %&gt;%
      bind_rows(subsample)
  }
})</code></pre>
<pre><code>##    user  system elapsed 
##    0.24    0.00    0.24</code></pre>
<p>I tracked the time and it doesn’t take all that long… but then again its only 100 loops.</p>
<p>After executing this loop, I can do my future analysis with the following data:</p>
<pre class="r"><code>head(coefdf)</code></pre>
<pre><code>## # A tibble: 6 x 6
##   `(Intercept)`  cut.L   cut.Q   cut.C `cut^4` carat
##           &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;
## 1        -3039.  1492.   -53.6    54.0   352.  8192.
## 2        -2413.  1164.  -182.   -309.    -60.6 7469.
## 3        -1045.   843. -1321.   1192.    537.  5753.
## 4        -2560.   970.   218.    168.     NA   7720.
## 5        -2401.   681.   148.    525.    524.  7377.
## 6        -1833. -2763.  3165.  -1695.   1159.  8471.</code></pre>
<pre class="r"><code>head(allsamples)</code></pre>
<pre><code>## # A tibble: 6 x 4
##   price carat cut       iteration
##   &lt;int&gt; &lt;dbl&gt; &lt;ord&gt;         &lt;int&gt;
## 1  1248  0.39 Ideal             1
## 2  1591  0.56 Ideal             1
## 3 10180  1.52 Premium           1
## 4 11014  1.52 Very Good         1
## 5  8235  1.27 Very Good         1
## 6   732  0.31 Premium           1</code></pre>
<p>But you can see how this can quickly balloon into taking too much time. We can solve that problem with parallel processing.</p>
</div>
<div id="parallel-processing" class="section level2">
<h2>Parallel Processing</h2>
<p>This code requires the following libraries:</p>
<pre class="r"><code>library(tidyverse)
library(foreach)
library(doParallel)</code></pre>
<p>Typically, all of our work is done is series. Sometimes, if jobs can be done in parallel, we can do this by sending them to different cores in our computer. The amount of time that this saves depends on the speed of your computer, the number of cores in which you can put to work doing jobs, and, of course, the amount of work you need done. Also, there is a ‘start up cost’ to firing up a core - but if you have a lot of repetitive processes that can be spread out and little that must be done for each core, you can save a lot of time.</p>
<p>First thing, we determine how many cores we have available on our computer to do the work.</p>
<pre class="r"><code>numCores &lt;- detectCores()
numCores</code></pre>
<pre><code>## [1] 8</code></pre>
<pre class="r"><code>registerDoParallel(numCores)</code></pre>
<p>Now I can execute the same code as above with <code>foreach</code> and <code>%dopar%</code>.</p>
<pre class="r"><code>data(&quot;diamonds&quot;)

diamonds = diamonds %&gt;%
  select(price,carat,cut)

allsamples = NULL
trials &lt;- 10000
system.time({
  r &lt;- foreach(i=icount(trials), .combine=rbind, .packages = &quot;tidyverse&quot;) %dopar% {
    subsample = diamonds %&gt;%
      sample_frac(.01) 
    result = lm(price~cut+carat+0,data = subsample)
    coefs = data.frame(t(coefficients(result)))
    list(subsample,coefs)
  }
})</code></pre>
<pre><code>##    user  system elapsed 
##    4.52    0.58    8.96</code></pre>
<p>Now we can retrieve the data from our ‘loop’ in the following way:</p>
<pre class="r"><code>coefs = 
bind_rows(r[,2],.id = &quot;iteration&quot;) %&gt;% as_tibble()
head(coefs)</code></pre>
<pre><code>## # A tibble: 6 x 7
##   iteration cutFair cutGood cutVery.Good cutPremium cutIdeal carat
##   &lt;chr&gt;       &lt;dbl&gt;   &lt;dbl&gt;        &lt;dbl&gt;      &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt;
## 1 result.1   -4664.  -2853.       -2196.     -2579.   -2202. 7913.
## 2 result.2   -3574.  -2793.       -2305.     -2567.   -2044. 7945.
## 3 result.3   -3389.  -2685.       -2416.     -2471.   -2139. 7925.
## 4 result.4   -3794.  -3007.       -2227.     -2708.   -2221. 8007.
## 5 result.5   -4450.  -2690.       -2788.     -2734.   -2511. 8359.
## 6 result.6   -3592.  -2804.       -2267.     -2517.   -1954. 7729.</code></pre>
<pre class="r"><code>sampledata = 
bind_rows(r[,1],.id = &quot;iteration&quot;) %&gt;% as_tibble()
head(sampledata)</code></pre>
<pre><code>## # A tibble: 6 x 4
##   iteration price carat cut      
##   &lt;chr&gt;     &lt;int&gt; &lt;dbl&gt; &lt;ord&gt;    
## 1 result.1    575  0.25 Very Good
## 2 result.1  10497  1.2  Very Good
## 3 result.1   1400  0.42 Ideal    
## 4 result.1   4202  1.1  Very Good
## 5 result.1   1800  0.53 Ideal    
## 6 result.1   5766  1.2  Ideal</code></pre>
<p>Now the point is to find a 95% confidence interval of what the true <span class="math inline">\(\beta_0\)</span> and <span class="math inline">\(\beta_is\)</span> are.</p>
<pre><code>##           vars       25%       95%
## 1      cutFair -4212.252 -3052.430
## 2      cutGood -2938.107 -2318.348
## 3 cutVery.Good -2502.356 -2039.622
## 4   cutPremium -2579.615 -2085.151
## 5     cutIdeal -2185.177 -1806.332
## 6        carat  7724.165  8249.379</code></pre>
<p>Looks like none of the confidence intervals contain <code>0</code>. Therefore carat does have a relationship with price for each level of cut.</p>
</div>
<div id="displaying-the-results" class="section level2">
<h2>Displaying the Results</h2>
<p>The ShinyApp I use to display the results is below.</p>
<p>If you’d rather view the app outside the blog, here is the <a href="https://westpointmath.shinyapps.io/parallelbootstrapdiamonds/">link</a></p>
<center>
<iframe src="https://westpointmath.shinyapps.io/parallelbootstrapdiamonds/" width="1000" height="500&quot;">
</iframe>
</center>
<p>I also include the code for the ShinyApp below the embedded application.</p>
<pre class="r"><code>allsamples = NULL
trials &lt;- 10000
  r &lt;-
    foreach(i = icount(trials),.combine = rbind,.packages = &quot;tidyverse&quot;) %dopar% {
              subsample = diamonds %&gt;%
                sample_frac(.001)
              result = lm(price ~ cut + carat + 0, data = subsample)
              coefs = data.frame(t(coefficients(result)))
              list(subsample, coefs)
            }

sampledata =
  bind_rows(r[, 1], .id = &quot;iteration&quot;)
coefs =
  bind_rows(r[, 2], .id = &quot;iteration&quot;)

help =
  sampledata %&gt;% as_tibble() %&gt;% janitor::clean_names()

coefdata =
  coefs %&gt;% as_tibble() %&gt;%
  gather(cuttype, intercept, -carat, -iteration)

shinyApp(
  ui = fluidPage(
    sliderInput(
      &quot;number&quot;,
      &quot;Which Iteration to Display&quot;,
      min = 1,
      max = trials,
      value = floor(runif(1, 1, trials))
    ),
    plotOutput(&quot;diamond&quot;)
  ),
  
  server = function(input, output) {
    subhelp = reactive({
      help %&gt;%
        mutate(iteration = as.numeric(str_remove(iteration, &quot;result.&quot;))) %&gt;%
        filter(iteration == input$number)
    })
    
    subcoefdata = reactive({
      coefdata %&gt;%
        mutate(iteration = as.numeric(str_remove(iteration, &quot;result.&quot;))) %&gt;%
        filter(iteration == input$number)
    })
    
    output$diamond = renderPlot({
      diamonds %&gt;%
        ggplot(aes(x = carat, y = price)) +
        geom_point(alpha = .1) +
        geom_point(data = subhelp(),
                   aes(x = carat, y = price),
                   color = &quot;blue&quot;) +
        geom_abline(data = subcoefdata(),
                    aes(intercept = intercept, slope = carat),
                    color = &quot;red&quot;) +
        facet_wrap( ~ cuttype, drop = TRUE, nrow = 1) +
        labs(
          x = &quot;Carat&quot;,
          y = &quot;Price&quot;,
          title = &quot;Price of Diamond as Carat Increases&quot;,
          subtitle = &quot;By Cut&quot;,
          caption = paste(&quot;Currently Showing Bootstrap Sample &quot;, input$number)
        )
    })
  },
  
  options = list(height = 1000)
)</code></pre>
</div>
</article>
    <footer class="post-footer">
      
      <ul class="post-tags">
        
          <li><a href="/tags/army-math"><span class="tag">Army Math</span></a></li>
        
          <li><a href="/tags/beatnavy"><span class="tag">Beatnavy</span></a></li>
        
          <li><a href="/tags/datascience"><span class="tag">Datascience</span></a></li>
        
          <li><a href="/tags/foreach"><span class="tag">Foreach</span></a></li>
        
          <li><a href="/tags/bootstrap"><span class="tag">Bootstrap</span></a></li>
        
      </ul>
      
      <p class="post-copyright">
        © This post is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License，please give source if you likes to quote or reproduce.This post was published <strong>376</strong> days ago, content in the post may be inaccurate, even wrong now, please take risk yourself.
      </p>
    </footer>
    
      <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "dusty-turner" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
      
    
  </section>
  <footer class="site-footer">
  <p>© 2017-2020 Dusty Turner</p>
  <p>Powered by <a href="https://gohugo.io/" target="_blank">Hugo</a> with theme <a href="https://github.com/laozhu/hugo-nuo" target="_blank">Nuo</a>.</p>
  
</footer>



<script async src="//cdn.bootcss.com/video.js/6.2.8/alt/video.novtt.min.js"></script>
<script async src="//cdn.bootcss.com/mathjax/2.7.2/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [['$','$'], ['\\(','\\)']],
      displayMath: [['$$','$$'], ['\[','\]']],
      processEscapes: true,
      processEnvironments: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
      TeX: { equationNumbers: { autoNumber: "AMS" },
      extensions: ["AMSmath.js", "AMSsymbols.js"] }
    }
  });
</script>
<script type="text/x-mathjax-config">
  // Fix <code> tags after MathJax finishes running. This is a
  // hack to overcome a shortcoming of Markdown. Discussion at
  // https://github.com/mojombo/jekyll/issues/199
  MathJax.Hub.Queue(() => {
    MathJax.Hub.getAllJax().map(v => v.SourceElement().parentNode.className += ' has-jax');
  });
</script>

<script src="/js/bundle.js"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-109926409-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>





  </body>
</html>
