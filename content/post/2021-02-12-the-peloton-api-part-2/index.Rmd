---
title: 'The Peloton API Part 2: A Valentine Peloton Tribute to my Wife'
author: Dusty Turner
date: '2021-02-14'
slug: the-peloton-api-part-2
categories:
  - API
  - Peloton
  - tidyverse
  - fitness
tags:
  - API
  - peloton
  - tidyverse
  - fitness
cover: /img/bikecover.jpg
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,warning = F,message = F)
```



# Peloton R

In [part 1](https://www.dustysturner.com/post/the-peloton-api-part-1/) of my Peloton API post, I explored the  [`pelotonR` package](https://github.com/bweiher/pelotonR) created by [Ben Weiher's](https://github.com/bweiher/).  Its a great package for accessing your Peloton data and I recommend it.  

In part 2, I'll explore a different Peloton package from [Laura Ellis](https://twitter.com/littlemissdata).  She provides a great [tutorial](https://lgellis.github.io/pelotonR/) to display the functionality.  

## Objectives

The objectives for this post is to...

1. Show how awesome my wife is.
2. Highlight a second package.
3. Create some visualizations to show display Peloton data.

In order to use this post as a teaching tool, I'll also include my code.  This also allows me to receive feedback from the community to how to improve my techniques.

## Inspiration

I developed many of these plots because I was curious, but I also used [this page](https://www.instagram.com/pelotondataviz/?hl=en) and [this page](https://www.qlik.com/blog/peloton-and-qlik-the-analytics-of-it-all) as inspiration.

Enough!  On with the analysis!

# Get the data

Lets start with a talk through to access your peloton data.

If you haven't already, install this Peloton library from github.

```{r, eval=F, include=T}
devtools::install_github("lgellis/pelotonR")
```

## Authenticate

Since I'm going to be pulling data for both my wife and I, I'll authenticate both our accounts.  Our passwords are saved in our `.RProfile` in a function I have saved there.  If you'd like to do the same, this [stack overflow post](https://stackoverflow.com/questions/46819684/how-to-access-and-edit-rprofile) is very helpful.

```{r}
library(tidyverse)
library(lubridate)
library(pelotonR)

me_auth_response <- pelotonR::authenticate(username = "dusty.s.turner@gmail.com", password = get_peloton_passwords("Dusty"))
wife_auth_response <- pelotonR::authenticate(username = "turner.jill.e@gmail.com", password = get_peloton_passwords("Jill"))
```

To access our personal data, I'll need to extract our user_ids for the next function

```{r}
me_user_id <- me_auth_response %>% jsonlite::parse_json() %>% .$user_id

wife_user_id <- wife_auth_response %>% jsonlite::parse_json() %>% .$user_id
```

Use the user id to request your data from the API

```{r}
my_workout_df <- pelotonR::get_workouts_and_instructors_df(user_id = me_user_id) %>% as_tibble()
wife_workout_df <- pelotonR::get_workouts_and_instructors_df(user_id = wife_user_id) %>% as_tibble()
```

## Collect and organize data

The package helps retrieve a TON of data about your workouts.  The first number is the workout count, but the second number is the number of columns returned about your data.

```{r}
my_workout_df %>% dim()
```

As we join and organize our data, I'm only going to select the columns that I end up using later on in the analysis.  If you dig through the data frame, you might find more interesting information to use. 

```{r}
interesting <-
  list(Dusty = my_workout_df,
       Jill = wife_workout_df) %>%
  bind_rows(.id = "Person") %>%
  rename_with(.fn = ~ str_remove(., pattern = "workout.")) %>%
  mutate(Length = peloton.ride.duration/60, KJ = total_work/1000) %>%  
  select(Person,start_date,Length, KJ, fitness_discipline,is_total_work_personal_record,start_time,workout_type,peloton.ride.difficulty_rating_avg,peloton.ride.is_explicit,peloton.ride.overall_estimate,peloton.ride.rating,peloton.ride.total_workouts,peloton.ride.difficulty_estimate,instructor.name) %>%
  mutate(start_time = lubridate::as_datetime(start_time, tz = "EST")) 

# interesting <-
# full_df %>% 
#     select(Person,created_at, device_type, fitness_discipline, is_total_work_personal_record,name, start_time,
#          total_work, workout_type, total_video_buffering_seconds, total_video_watch_time_seconds,peloton.ride.duration,
#          peloton.ride.difficulty_rating_avg,peloton.ride.difficulty_rating_count,peloton.ride.difficulty_level,peloton.ride.duration,peloton.ride.pedaling_duration,
#          peloton.ride.fitness_discipline,peloton.ride.id, peloton.ride.is_explicit,peloton.ride.is_live_in_studio_only,
#          peloton.ride.length, peloton.ride.overall_estimate,peloton.ride.overall_rating_avg,peloton.ride.overall_rating_count,
#          peloton.ride.pedaling_duration,peloton.ride.rating,peloton.ride.series_id,peloton.ride.total_ratings,peloton.ride.total_workouts,
#          peloton.ride.difficulty_estimate,peloton.ride.difficulty_level,peloton.ride.difficulty_rating_avg,peloton.ride.difficulty_rating_count,
#          start_date,instructor.name,instructor.username) %>% 
#     mutate(start_time = lubridate::as_datetime(start_time, tz = "EST"))  

```

You'll notice that I did a few standard pre-processing steps.  The ride duration is tracked in second (which I convert to minutes) and the work is tracked in Joules (which I convert to Kilojoules),

# Dig into the data!

As you can see, riding the peloton is not the only thing we do on the bike.

```{r}
interesting %>% 
  count(Person, fitness_discipline) %>% 
  pivot_wider(names_from = Person, values_from = n, values_fill = 0)
```

I'd like to limit my data to only cycling classes.  Later on, I'll wish to only look at rides lasting 20 minutes or longer.  To support this filter that I'll need to do over and over, I'll set up a function.

```{r}

standard_filter <- function(data, only_long_classes = FALSE, remove_unknown_instructors = FALSE){
  out <-
    data %>% 
    filter(fitness_discipline == "cycling") %>% 
    filter(workout_type == "class") %>% 
    mutate(instructor.name = if_else(is.na(instructor.name), "Unknown", instructor.name)) %>% 
    select(-c(fitness_discipline, workout_type)) %>%
    filter(complete.cases(.)) %>% 
    arrange(start_time) %>% 
    group_by(Person) %>% 
    mutate(ride_number = row_number()) %>% 
    ungroup() 
  
  if(remove_unknown_instructors){
    out <-
      out %>% 
      filter(instructor.name != "Unknown")
  }
  
  if(only_long_classes){
    out <-
      out %>% 
      filter(Length >= 20)
  }
  
  return(out)
}

```


Lets take a few different looks at our data.  The first question I'd like to dig into is, "Who are out favorite instructors?"

## Favorite instructors

```{r}
interesting %>%
  standard_filter(remove_unknown_instructors = T) %>% 
  count(Person, instructor.name) %>% 
  mutate(n = ifelse(Person == "Dusty", n * -1, n)) %>% 
  group_by(instructor.name) %>% 
  mutate(order_by = max(ifelse(Person=="Jill", n, 0))) %>% 
  ungroup() %>% 
  mutate(instructor.name = fct_reorder(instructor.name, order_by)) %>% 
  ggplot(aes(x= instructor.name, y = n, fill = Person)) +
  geom_col() +
  coord_flip() +
  scale_y_continuous(breaks = c(-100,-50,0,50,100,150,200), labels = c("100", "50", "0", "50", "100", "150", "200")) +
  scale_fill_manual(values = c("#FF7105","#236AB9")) +
  labs(y = "Number of Rides", x = "Instructor") 
```

First things is first.  Jill rides WAY more than me.  But also, we can see a difference in rider preferences.  She prefers Ally Love, Emma Lovewell, and Hannah Corbin, while I prefer Jess King, Kendall Toole, and Alex Toussaint.  

### How our favorite instructors change over time

```{r}
interesting %>% 
  standard_filter(only_long_classes = T) %>% 
  mutate(month = month(start_time), year = year(start_time)) %>% 
  group_by(Person,month,year) %>% 
  filter(n()>=5) %>% 
  ungroup() %>% 
  count(Person, instructor.name,month, year) %>% 
  mutate(date = lubridate::ym(str_c(year," ",month))) %>% 
  group_by(Person,date) %>% arrange(Person, date) %>% 
  mutate(instructor.name = if_else(n == max(n), instructor.name, "Other")) %>% 
  group_by(Person, instructor.name,date) %>% 
  summarise(n = sum(n)) %>% 
  arrange(Person, date) %>% 
  group_by(Person,date) %>% 
  mutate(percent = n / sum(n)) %>% 
  ungroup() %>% 
  ggplot(aes(x = date, y = percent, fill = instructor.name)) +
  geom_col() +
  facet_wrap(~Person, scales = "free") +
  coord_flip() +
  labs(title = "Most popular instructor each month", subtitle = "How instructor preference changes over time",
       x = "Percent of Monthly Rides", y = "", fill = "Instructor")
```


### Class length / instructor preference?

```{r}
interesting %>% 
  standard_filter(remove_unknown_instructors = T) %>% 
  count(Person,instructor.name,Length) %>% 
  complete(Person,instructor.name,Length) %>% 
  mutate(Length = as.factor(Length)) %>% 
  group_by(instructor.name) %>% mutate(order_by = sum(n,na.rm = T)) %>%
  group_by(Person, Length) %>% mutate(max_time_slot = rank(n,na.last = F)) %>% 
  mutate(most = if_else(max(max_time_slot)== max_time_slot, "MAX", "Not MAX")) %>% 
  mutate(most = if_else(is.na(n), "NA", most)) %>% 
  ggplot(aes(x = Length, y = fct_reorder(instructor.name,order_by))) +
  geom_tile(aes(fill = most),show.legend = F) +
  geom_text(aes(label = n), show.legend = F) +
  scale_fill_manual(values = c("#AE0D7A","#F7EDD4", "#448D76")) +
  facet_wrap(~Person) +
  labs(y = "Instructor", title = "Preferred Instructors for each ride length") 

```

### Most difficult instructors based on our chosen rides

```{r}
interesting %>% 
  standard_filter(only_long_classes = T) %>% 
  mutate(instructor.name = fct_lump_min(instructor.name, min = 10)) %>%
  group_by(instructor.name) %>% 
  mutate(max_difficulty = max(peloton.ride.difficulty_estimate, na.rm = T)) %>% 
  mutate(min_difficulty = min(peloton.ride.difficulty_estimate, na.rm = T)) %>% 
  group_by(instructor.name) %>% 
  mutate(median_diff = median(peloton.ride.difficulty_estimate)) %>% 
  ungroup() %>% 
  mutate(instructor.name = fct_reorder(instructor.name, median_diff)) %>% 
  ggplot(aes(x = peloton.ride.difficulty_estimate, y = instructor.name)) +
  geom_segment(aes(x = min_difficulty, xend = max_difficulty, yend = instructor.name), color = "grey") +
  geom_point(color = "black") +
  geom_point(aes(x = median_diff), color = "#B32134", size = 4) +
  geom_point(aes(x = max_difficulty), color = "green", size = 4) +
  geom_point(aes(x = min_difficulty), color = "green", size = 4) +
  scale_x_continuous(breaks = 3:10, limits = c(3,10)) +
  labs(x = "Ride Difficulty Rating", y = "Instructor", title = "Difficulty Ratings of our most population instructors",
       subtitle = "Sorted by median ride difficulty \nIncludes instructors with at least 10 rides \nRides 20 minutes or longer", 
       caption = "Green dots represent maximum and minimum difficulty of rides between my wife and I")

```

### Instructor Race

Which instructors have we expended the most KJs on over time. 

```{r}
library(gghighlight)

instructor_race <- function(name = "Jill"){
 limit <-  if_else(name == "Dusty", 5000,10000)
  
interesting %>% 
standard_filter() %>% 
  group_by(Person, instructor.name) %>% 
  arrange(start_time) %>% 
  mutate(Total_KJ = cumsum(KJ)) %>% 
  ungroup() %>% 
  filter(Person == name) %>%
  ggplot(aes(x = start_time, y = Total_KJ, color = instructor.name)) +
  geom_line() +
  scale_y_continuous(labels = scales::comma) +
  gghighlight(max(Total_KJ) > limit, unhighlighted_params = list(color = "grey")) +
  scale_color_manual(values = c("#FDAC53","#9BB7D4","#A0DAA9","#E9897E","#0072B5")) +
  labs(x = "", y = "Total KJ", subtitle = str_c(name,"'s Instructor Race"), title = "KJ output by instructor over time")
}
  
instructor_race(name = "Dusty")
instructor_race(name = "Jill")

```



## When do we like to ride?

I already know this answer.  Pretty much every morning, when I wake up, my wife is crushing it in the basement on the Peloton.  But a picture is worth 1000 KJ so lets explore this visually.


```{r}
weekday <- tibble(weekday_name = weekdays(x=as.Date(seq(7), origin="1950-01-01")),
       weekday = c(2:7,1))

interesting %>% 
  standard_filter() %>%
  select(Person, start_time) %>% 
  mutate(hour = as.factor(hour(start_time))) %>% 
  mutate(weekday = wday(start_time)) %>% 
  left_join(weekday) %>%
  mutate(weekday_name = fct_reorder(weekday_name, weekday)) %>% 
  count(Person, hour, weekday_name) %>% 
  complete(Person,hour,weekday_name) %>% 
  ggplot(aes(x = weekday_name, y = hour, fill = n))+
  geom_tile(show.legend = F) +
  facet_wrap(~Person) +
  scale_x_discrete(labels = c("1" = "Sunday")) +
  scale_fill_gradient2(na.value = "white", low = "white", high = "#5932a8", mid = "grey", midpoint = 10) +
  geom_text(aes(label = n)) +
  labs(x = "Weekday", y = "Hour")
```

It is clear that my wife is a motivated morning rider while I'm more likely to ride in the evening.  On weekends our workouts are more spread out as we are gettinga workout in when we can find space.  

### What weekday do we like to ride and how well do we perform in KJs?

```{r}
interesting %>% 
  standard_filter() %>% 
  mutate(weekday = lubridate::wday(start_time)) %>% 
  left_join(weekday)  %>% 
  group_by(Person,weekday_name, weekday) %>% 
  summarise(num_rides = n(), Tot_KJ = sum(KJ), Tot_mins = sum(Length)) %>% 
  mutate(ave_KJ_per_min = round(Tot_KJ / Tot_mins, 1)) %>% 
  group_by(Person) %>% 
  mutate(prop_rides = num_rides/sum(num_rides)) %>% 
  ungroup() %>% 
  mutate(weekday_name = fct_reorder(weekday_name,weekday, .desc = T)) %>% 
  mutate(max_dusty = max(ifelse(Person == "Dusty", Tot_mins,0))) %>% 
  ggplot(aes(y = weekday_name, x = prop_rides, fill = Tot_mins)) +
  geom_col() +
  geom_text(aes(label = ave_KJ_per_min)) +
  scale_fill_gradientn(breaks = c(0,1100,2500,5000), colors = c("grey","green","red")) +
  facet_wrap(~Person) +
  labs(x = "Proportion of Total Rides",  y = "", fill = "Total Minutes",
       title = "Proportion of Rides on Each Day \nColored by Total Minutes Spent Riding",
       subtitle = "Label is Average KJ / Min on that day")
```


## Improvement over time

### KJs per ride

```{r}

interesting %>% 
  standard_filter(remove_unknown_instructors = F) %>%
  ggplot(aes(x = start_time, y = KJ)) +
  geom_point() +
  geom_smooth(method = "lm") +
  scale_x_datetime(date_breaks = "6 months", date_labels = "%b %y") +
  facet_grid(Person~Length)

```

## Personal Records Over Time

```{r}
interesting %>% 
  standard_filter(only_long_classes = T) %>% 
  group_by(Person, Length) %>% 
  mutate(ride_number = row_number()) %>% mutate(is_max = cummax(KJ)) %>%   
  mutate(max = ifelse(is_max == lag(is_max), "NO", "YES")) %>% 
  mutate(max = replace_na(max, "NO")) %>% 
  ungroup() %>% 
  mutate(date = date(start_time)) %>% 
  mutate(date_label = ifelse(max,as.character(date),"")) %>% 
  group_by(Person, Length) %>% 
  mutate(max = if_else(KJ == max(KJ), "SUPER MAX", max)) %>% 
  ungroup() %>% 
  ggplot(aes(x = ride_number, y = KJ)) +
  geom_line() +
  geom_smooth(method = "lm") +
  geom_point(aes(size = max, color = max), show.legend = F) +
  scale_color_manual(values = c("black", "orange", "blue")) +
  scale_size_manual(values = c(.1,5,2)) +
  facet_grid(Length~Person, scales = "free") +
  labs(x = "Ride Number", y = "Output: KJ", title = "Personal Record Improvement Over Time", subtitle = "Of the most common ride durations")
```



### KJ burned per minute rolling average

```{r}
interesting %>% 
  standard_filter(only_long_classes = T) %>% 
  mutate(KJ_per_min = KJ/Length) %>% 
  group_by(Person) %>% 
  # group_by(Person,Length) %>% 
  mutate(roll_avg = zoo::rollmean(x = KJ_per_min,k = 5, fill = 0, align = "right")) %>% 
  arrange(start_time) %>% 
  mutate(ride_number = row_number()) %>% 
  ungroup() %>%
  # arrange(desc(start_time)) 
  filter(roll_avg != 0) %>% 
  # ggplot(aes(x = ride_number, y = roll_avg)) +
  ggplot(aes(x = start_time, y = roll_avg)) +
  geom_line() +
  geom_point(aes(y = KJ_per_min, color = as.factor(Length)), alpha = .3, show.legend = T) +
  scale_y_continuous(breaks = seq(5,14,1), minor_breaks = seq(5,14,.5)) +
  facet_wrap(~Person, scales = "free_x") +
  # facet_grid(Length~Person)
  labs(y = "KJ per Minute", y = "Ride Date", color = "Ride Length",
       title = "5 Ride Rolling KJ per Minute Average")

```




## Chasing My Wife's Greatness

My wife puts in the minutes - even more in recent months.

```{r}

interesting %>% 
  standard_filter(remove_unknown_instructors = F) %>% 
  # select(Person, fitness_discipline,start_time,peloton.ride.duration, total_work, peloton.ride.length, workout_type) %>% 
  group_by(Person) %>% 
  mutate(`Total KJ` = cumsum(KJ), `Total Minutes Biked` = cumsum(Length)) %>% 
  rename(`Ride Number` = ride_number) %>% 
  pivot_longer(c(`Total KJ`,`Total Minutes Biked`, `Ride Number`)) %>% 
  ggplot(aes(x=start_time, y = value, color = Person)) +
  geom_line() +
  scale_color_manual(values = c("#FF7105","#236AB9")) +
  scale_y_continuous(labels = scales::comma) +
  facet_wrap(~name, scales = "free_y") +
  labs(y = "Total KJ", x = "")

```

### Net difference in metrics

```{r}
totals <-
interesting %>% 
  standard_filter() %>% 
  group_by(Person) %>% 
  arrange(Person,start_time) %>% 
  mutate(day = lubridate::date(start_time)) %>%
  mutate(ride_number = 1)  %>% 
  mutate(across(.cols = c(Length, KJ, ride_number), .fns = ~cumsum(.))) %>% 
  select(Person, ride_number, KJ, minutes = Length) %>% 
  ungroup() %>% 
  mutate(minutes = minutes / 60)

library(ggforce)

full_join(
  totals %>% filter(Person == "Dusty"),
  totals %>% filter(Person == "Jill"),
  by = "ride_number", suffix = c("_Dusty", "_Jill")
  )  %>% 
  arrange(ride_number) %>% 
  mutate(dusty_max_ride_number = max(KJ_Dusty, na.rm = T)) %>% 
  mutate(dusty_max_ride_number = max(if_else(dusty_max_ride_number == KJ_Dusty, ride_number, 0),na.rm = T)) %>% 
  fill(everything()) %>%
  mutate(`Difference in KJ` = KJ_Jill - KJ_Dusty,
         `Difference in Minutes` = minutes_Jill - minutes_Dusty) %>% 
  pivot_longer(cols = contains("difference"))  %>% 
  mutate(dusty_plus = value < 0)  %>% 
  ggplot(aes(x = ride_number, y = value,color = dusty_plus)) +
  geom_path(aes(group = 1),show.legend = F) +
  geom_vline(aes(xintercept = dusty_max_ride_number)) +
  scale_color_manual(values = c("#FF7105","#236AB9")) +
  scale_y_continuous(labels = scales::comma) +
  facet_wrap(~name, scales = "free") +
  labs(y = "", x = "Ride Number") 

full_join(
  totals %>% filter(Person == "Dusty"),
  totals %>% filter(Person == "Jill"),
  by = "ride_number", suffix = c("_Dusty", "_Jill")
  )  %>% 
  arrange(ride_number) %>% 
  mutate(dusty_max_ride_number = max(KJ_Dusty, na.rm = T)) %>% 
  mutate(dusty_max_ride_number = max(if_else(dusty_max_ride_number == KJ_Dusty, ride_number, 0),na.rm = T)) %>% 
  fill(everything())   %>%
  mutate(`Difference in KJ` = KJ_Jill - KJ_Dusty,
         `Difference in Minutes` = minutes_Jill - minutes_Dusty) %>% 
  mutate(dusty_plus = `Difference in KJ` < 0)  %>% 
  ggplot(aes(x = ride_number, y = `Difference in KJ`,color = dusty_plus)) +
  geom_path(aes(group = 1),show.legend = F) +
  geom_vline(aes(xintercept = dusty_max_ride_number)) +
  scale_color_manual(values = c("#FF7105","#236AB9")) +
  scale_y_continuous(labels = scales::comma) +
  labs(y = "", x = "Ride Number") +
  facet_zoom(ylim = c(-17000,0000), xlim = c(0,350))
  

```


## Ride difficulty

```{r}
interesting %>% 
  standard_filter(only_long_classes = T) %>% 
  group_by(Person) %>% 
  mutate(max_difficulty = max(peloton.ride.difficulty_estimate, na.rm = T)) %>% 
  mutate(min_difficulty = min(peloton.ride.difficulty_estimate, na.rm = T)) %>% 
  mutate(median_difficulty = median(peloton.ride.difficulty_estimate, na.rm = T)) %>% 
  ggplot(aes(x = peloton.ride.difficulty_estimate, y = Person)) +
  geom_segment(aes(x = min_difficulty, xend = max_difficulty, yend = Person)) +
  geom_point() +
  geom_point(aes(x = median_difficulty), color = "#B32134", size = 4) +
  geom_point(aes(x = max_difficulty), color = "green", size = 4) +
  geom_point(aes(x = min_difficulty), color = "green", size = 4) +
  labs(x = "Ride Difficulty Rating", y = "", title = "Difficulty ratings for each rider",
       subtitle = "Green: max and min difficulty \nRed: median difficulty")

```

